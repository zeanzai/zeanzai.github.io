---
"title": "SQL执行原理"
category:
  - "MySQL"
tag:
  - "数据库"
---




## 一条SQL语句的查询

如果where中的筛选条件是并没有创建索引的普通列，那么如何在众多的数据页中定位出我们想要的那一条数据记录呢？

根据页的解构信息，我们基本可以断定，就是通过根页信息，然后依次查询每一个页，并在每一个页内，通过页目录比对页内的每一条数据记录，假如比对了一百万个数据记录才找到，那就只能比对一百万次。这个就是全表扫描的大概原理。但是我们会发现，这样的查找过程效率太低，我们知道CPU加载数据记录是以页为基本单位的，也就是如果有100个页，那我们可能需要100次IO才能找到一条记录信息，假设服务器一次IO平均时长为200ms，那么100次，就需要20s左右的时间，也就是查询一条记录大概需要20s时间，这是我们所不能忍受的。

为了解决这个问题，InnoDB大神们设计出了索引的概念，目的就是帮助我们快速查找到数据。

解决这个问题的方向有了，那就是索引，可是，如何具体设计呢？这里涉及到两个问题：

1. 索引的数据结构是怎样的？
2. 如何设计索引的相关算法？


我们已经知道行数据可以通过页目录进行二分查找，那我们当然也可以对页创建目录，如何保存这个目录呢，我们同样使用页的结构，只不过数据记录部分我们保存页的信息（也就是页号）。

这样我们的查找过程就变成了，从根页开始，先去查找页的目录，定位到具体数据信息在哪一个页上，然后再通过页内查找，是不是就可以不用全表扫描了。这个过程是可行的，但是涉及到另外一个问题，从根页开始之后，如何查找页的记录？我们可以在创建页的目录的时候就把筛选的这个列值与数据页的信息保存到一起，一块作为页的目录里面的数据，这样我们在查找页的目录的时候，就可以通过比对筛选条件与记录下来的列值信息，来定位到数据页的编号。这样我们就可以定位到数据具体会在哪一个数据页上面。

![20230612162053](https://tianqingxiaozhu.oss-cn-shenzhen.aliyuncs.com/blog20230612162053.png)

举例说明，InnoDB为一个表的某一列name创建索引的过程大概是这样的：

1. 先创建一个空页，页里面保存一种页目录的数据，即record_type=1的行数据，然后这个行的真实数据部分保存name的值和页号，为了保存的更多，把实际的数据记录进行分组，这个空页中我们只保存两条记录，一条记录为name=1，pageno=35， 一条记录为name=400，pageno=20；
2. 然后我们在pageno=35的页上创建数据记录，保存name=1到name=399的记录；在pageno=20的页上创建数据记录，并保存name=400及剩下的所有记录；

在加上行与行之间的单向链表关系、页与页之间的双向链表关系，就形成了B+树。

查找过程就是先定位到页号，然后再比对，整体都是二分法查找。




## 问题

如何保证两阶段提交的？如何保证XA的？


## 参考链接

- https://dev.mysql.com/doc/refman/5.7/en/innodb-locking.html
- 




<br /><br /><br />
<img style="border:1px red solid; display:block; margin:0 auto;" src="https://tianqingxiaozhu.oss-cn-shenzhen.aliyuncs.com/img/qrcode.jpg" alt="微信公众号" />


