---
title: "01 微服务与SpringCloud"
category:
  - "arch"
tag:
  - "springcloud"
---

学习的思路：一种新的技术的产生或一种新的架构思路的产生，一定是过去的旧事物无法满足现有问题的解决，或者是一定是原有的旧事物有些问题需要解决。因此，在学习新技术的时候，这种思想就可以作为一种指导思想。

## 1. 微服务架构概述

架构主要分为三种架构类型，这三种架构类型分别是：应用架构、业务架构、技术架构，业务架构决定了应用架构，技术架构支撑了应用架构。架构的发展经历了三个阶段：单体应用到分布式架构、分布式架构到soa架构、soa架构到微服务架构。

早期的单体应用架构的缺点：
- 所有的功能都集中在一个应用中；如果业务复杂会造成，整个应用的代码量很大；
- 模块之间界限不明，导致模块与模块之间的耦合度很高；
- 出现某一个小错误，就会造成整个应用的不可启动；
- 团队成员之间的协作灵活性较差：模块a可能依赖模块b，a开发完成后，需要等待b的开发；
- 很可能要求开发人员前后端同时开发，这对开发人员的技术功力要求很大；
- 很容易造成前后端责任界限不够清晰，比如有可能会在前端进行业务处理；

分布式架构的特点：
- 按照业务进行垂直划分，简单来讲，就是把原来的单体应用划分成多个应用，每一个应用都是一个单体应用，通过api相互调用来实现整体的应用的功能；

SOA架构与微服务架构的区别：
- todo

微服务架构的一些常见功能：
- 服务注册与发现
- 负载均衡
- 熔断与容错
- 配置中心
- 网关与链路监控




## 2. SpringCloud与中间件

学习策略：本章节主要包括了SpringCloud中间件与其他中间件之间的关系，中间件解决了在企业级应用开发过程中遇到的哪些困难，中间件产生的背景、中间件的功能、以及Springcloud针对这些中间件的具体实现。


### 2.1. 中间件概述

以前的中间件与操作系统和数据库并列为传统基础软件的三家马车，是运行在操作系统之上、应用软件之下的“中间层”的软件。但是随着云计算的发展，软件大规模向互联网云服务进行演化，中间件在整个过程中也不断扩大和演进自己的边界。中间件开始向下屏蔽异构的硬件设备、软件和网络等计算资源，向上提供应用、运行、维护等全生命周期的统一计算环境与管理。常见的中间件有：服务治理中间件、配置中心、全链路监控、分布式事务、分布式定时任务、消息中间件、api网关、分布式缓存、数据库中间件等。

### 2.2. SpringCloud概述

`本质上是一个中间件、目前由spring官方维护，基于SpringBoot开发，实现了微服务架构思想的一套中间件产品。`它提供了一系列的组件功能，如服务注册与发现（eureka、consul）、配置中心（config、nacos）、全链路监控（sleuth）、api网关（zuul、gateway、）、熔断器（hystrix）等选型中立（不依赖于平台和技术）的开源组件。每个独立的组件都有各自的软件版本，所有的组件合并成一个SpringCloud的版本，版本号由伦敦地铁站字母序命名。

### 2.3. SpringCloud与服务治理中间件

服务治理中间件的基本功能包括以下内容。

- 服务治理
  - 服务注册与发现（Eureka、zk、consul）
  - 服务路由
    - 服务上下线
    - 在线测试
    - 机房就近选择
    - ab测试
    - 灰度发布
  - 负载均衡
    - 根据目标状态和目标权重进行负载均衡
  - 自我保护
    - 服务降级
    - 优雅降级
    - 流量控制
- 丰富的治理管理机制

### 2.4. SpringCloud与配置中心中间件

配置中心产生的原因：在单体应用中 ，我们一般会把属性配置和代码硬编码到一起，但在分布式系统中，由于会存在多个服务实例，因此就需要管理每一个具体服务工程中的配置，上线前也需要checklist并逐个检查每一个上线的服务是否配置正常，且如果系统一旦上线，需要修改某项配置，就需要重启服务。这样管理起来非常麻烦。因此配置中心应运而生。

要求配置中心具有的功能有： 面向全公司（要求支持不同语言的应用接入）、要求与公司运维体系进行集成、要求对权限进行管理、要求对已有的配置中心进行兼容。

具体的实现有SpringCloud config和携程开源的配置中心Apollo。


### 2.5. SpringCloud与网关中间件
出现在系统边界上的一个面向api、串行集中式的强管控服务，可以理解为企业级应用防火墙，主要起到隔离外部应用和内部应用的作用。

要求网关中间件具备的几个功能：
  - 统一接入功能
    - 为各个无线应用提供统一的接入服务，提供一个高性能、高并发、高可靠的网关服务。还需要支持负载均衡、容灾切换、异地多活。
  - 协议适配功能
    - 针对不同的后端提供的不同的服务协议进行适配。比如当一个http请求经过网关后，通过一系列不同的fitter进行处理完毕后，需要进行协议适配，然后判断协议转发调用的到底是rpc服务还是rest服务或者是php提供的服务。
  - 流量管控功能
    - 网关作为所有请求流量的入口，当流量瞬间剧增，需要进行流量管控、流量调拨，服务不可用时，还需要网关进行熔断和降级。在异地多活场景下，还需要对流量进行切片，路由到不同的机房。
  - 安全防护功能
    - 对所有的请求进行安全防护过滤，保护后端服务。还可以通过与安全风控部门进行合作，对ip黑名单、URL和名单封禁控制，做风控防护、防止恶意攻击等。

Springcloud中的网关
  - zuul： qps很低，原理是针对每一个请求都分配一个线程来处理，qps最多一两千，高并发场景下，不推荐；
  - gateway： 底层是基于netty的多线程reactor模型实现，使用boss线程和worker线程接受异步处理请求，具有很强的高并发处理能力；

### 2.6. SpringCloud与全链路监控中间件

一个通过浏览器或移动客户端的前端请求到后端应用，会经过很多应用系统，并留下足迹和相关日志信息。但是这些分散到每一个业务主机下的日志不利于问题排查和问题定位。此时全链路监控中间件就应运而生。全链路监控中间件主要功能应该包括：
- 定位慢调用
- 定位各种错误和异常
- 实现依赖和拓扑
- 追踪调用链
- 应用告警

springcloud中的全链路监控中间件： pinpoint、skywalking等。


## 3. SpringCloud增强生态

上述章节中介绍了微服务架构中遇到的一些问题以及微服务架构过程中所出现的一些技术，以及Springcloud基于这些问题所做的一些实现。
但是这些还不够。还有一些问题需要解决：
- 单体应用拆分后，进程间通信机制和故障处理措施变的更加复杂；
- 微服务化后，一个看似简单的功能，可能需要调用多个服务并操作多个数据库才能实现，这就使得分布式事务问题变得异常突出；
- 微服务数量众多，测试、部署和监控问题变得更加困难；

针对第一个问题，随着RPC框架的成熟，已经得到解决；Docker、Devops技术的发展以及各公有云Paas平台自动化运维工具的推出，第三个问题也变得很容易；唯独第二个问题还是一件具有挑战性的问题。

针对第一个问题，可以使用SpringCloud和gRPC进行集成，也可以使用SpringCloud与Dubbo生态的融合（如：spring-clod-dubbo项目，就是把dubbo融入SpringCloud生态，使微服务调用同时具备RESTful和Dubbo调用的能力，做到对业务代码无侵入、无感知，如果使用过程中引入jar包，就在服务调用间使用dubbo，如果去掉jar包，则使用默认的RESTful）。

归根结底，SpringCloud是技术上的一种架构，只是解决了架构层面的问题，但对于业务怎么开发、业务架构怎么治理、架构怎么防腐、如何解决应用架构间的复杂性问题，还需要方法论指导，此时，引入DDD面向领域设计模型的指导思想。

<img style="border:1px red solid; display:block; margin:0 auto;" :src="$withBase('/qrcode.jpg')" alt="微信公众号" />
